{% extends 'layout.html' %}

{% block body_block %}
{% include '_messages.html' %}
<div class="container mt-4">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
        <a class="navbar-brand" href="/admin">ADMIN</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown"
            aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav">
                <li class="nav-item active"><a class="nav-link" href="/admin">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="admin/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/brands">Brands</a></li>
                <li class="nav-item"><a class="nav-link" href="/categories">Categories</a></li>
            </ul>
        </div>
    </nav>

    {% block content %}
    
    <!-- 4 Cards en ligne -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary h-100">
                <div class="card-body">
                    <h5 class="card-title">Total des ventes</h5>
                    <p class="card-text" id="total-sales">{{ total_sales }} TND</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info h-100">
                <div class="card-body">
                    <h5 class="card-title">Produits distincts</h5>
                    <p class="card-text" id="total-products">{{ total_products }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning h-100">
                <div class="card-body">
                    <h5 class="card-title">Catégories</h5>
                    <p class="card-text" id="total-categories">{{ total_categories }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success h-100">
                <div class="card-body">
                    <h5 class="card-title">Total commandes</h5>
                    <p class="card-text" id="total-orders">{{ total_orders }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques côte à côte -->
    <div class="row my-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Nombre de produits par catégorie</h5>
                </div>
                <div class="card-body">
                    <canvas id="productsByCategoryChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Ventes par Catégorie</h5>
                </div>
                <div class="card-body">
                    <canvas id="salesChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

<!-- Répartition des commandes par statut (centré) -->
<div class="row my-4 justify-content-center">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title text-center">Répartition des commandes par statut</h5>
            </div>
            <div class="card-body">
                <canvas id="statusPieChart" height="200" style="width: 100%; height: auto;"></canvas>
            </div>
        </div>
    </div>
</div>

    <!-- Prévision des ventes -->
    <div class="row my-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Prévision du montant total sur les 12 prochains mois</h5>
                </div>
                <div class="card-body">
                    <canvas id="predictionChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    {% endblock %}
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    new Chart(document.getElementById('productsByCategoryChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ category_names | tojson }},
            datasets: [{
                label: 'Nombre de produits',
                data: {{ category_counts | tojson }},
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Nombre de produits' }
                },
                x: {
                    title: { display: true, text: 'Catégories' }
                }
            }
        }
    });

    new Chart(document.getElementById('salesChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ labels | tojson | safe }},
            datasets: [{
                label: 'Ventes',
                data: {{ sales | tojson | safe }},
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });

    new Chart(document.getElementById('predictionChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: {{ prediction_labels | tojson | safe }},
            datasets: [{
                label: 'Prédiction des ventes',
                data: {{ prediction_values | tojson | safe }},
                borderColor: 'rgba(255, 99, 132, 1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });

    new Chart(document.getElementById('statusPieChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: {{ order_status_labels | tojson }},
            datasets: [{
                data: {{ order_status_counts | tojson }},
                backgroundColor: ['#FF5733', '#33FF57', '#3357FF', '#FF33A6'],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.raw + ' commandes';
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
